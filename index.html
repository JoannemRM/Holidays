<script>
  // Fecha actual
  const hoy = new Date();

  // FunciÃ³n para crear fechas de prueba
  function crearFechaFutura(dias) {
    const d = new Date();
    d.setDate(d.getDate() + dias);
    return d.toISOString().split("T")[0];
  }

  // Festivos reales + de prueba
  const festivos = [
    { pais: "Inglaterra y Gales", nombre: "Good Friday", fecha: "2025-04-18", tipo: "Nacional" },
    { pais: "Inglaterra y Gales", nombre: "Easter Monday", fecha: "2025-04-21", tipo: "Nacional" },
    // Festivos de prueba
    { pais: "ðŸ”” Prueba", nombre: "Festivo de prueba (5 dÃ­as)", fecha: crearFechaFutura(5), tipo: "Prueba" },
    { pais: "ðŸ”” Prueba", nombre: "Festivo de prueba (2 dÃ­as)", fecha: crearFechaFutura(2), tipo: "Prueba" },
  ];

  const lista = document.getElementById("festivos");

  // Mostrar los festivos en la lista
  festivos.forEach(f => {
    const item = document.createElement("li");
    item.className = "bg-white p-4 rounded shadow hover:shadow-lg transition";
    item.innerHTML = `
      <div class="text-xl font-semibold">${f.nombre}</div>
      <div class="text-sm text-gray-600">${f.pais} Â· ${f.fecha} Â· ${f.tipo}</div>
    `;
    lista.appendChild(item);
  });

  // Pedir permiso de notificaciones
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  // Almacenamiento local para no repetir notificaciones
  const notificados = JSON.parse(localStorage.getItem("notificadosFestivos") || "{}");

  function guardarNotificado(id) {
    notificados[id] = true;
    localStorage.setItem("notificadosFestivos", JSON.stringify(notificados));
  }

  function revisarNotificaciones() {
    const hoy = new Date();
    const hoyStr = hoy.toISOString().split("T")[0];

    festivos.forEach(f => {
      const fechaFestivo = new Date(f.fecha);
      const avisos = [
        { diasAntes: 5, id: `${f.fecha}_5` },
        { diasAntes: 2, id: `${f.fecha}_2` }
      ];

      avisos.forEach(({ diasAntes, id }) => {
        let fechaAviso = new Date(fechaFestivo);
        fechaAviso.setDate(fechaAviso.getDate() - diasAntes);

        // Si cae en fin de semana, adelantar al viernes
        const diaSemana = fechaAviso.getDay();
        if (diaSemana === 6) fechaAviso.setDate(fechaAviso.getDate() - 1); // sÃ¡bado
        else if (diaSemana === 0) fechaAviso.setDate(fechaAviso.getDate() - 2); // domingo

        const fechaAvisoStr = fechaAviso.toISOString().split("T")[0];

        if (hoyStr === fechaAvisoStr && !notificados[id]) {
          new Notification(`ðŸŽ‰ Festivo en ${f.pais}`, {
            body: `${f.nombre} es el ${f.fecha}`,
            requireInteraction: true // No se cierra automÃ¡ticamente
          });
          guardarNotificado(id);
        }
      });
    });
  }

  revisarNotificaciones();
  setInterval(revisarNotificaciones, 60 * 1000);
</script>
